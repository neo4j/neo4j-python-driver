#!/usr/bin/env bash
set -e

ROOT=$(dirname "$0")/..
SCRIPT=$(basename "$0")
TWINE_ARGS=("--verbose")


function help {
    echo "usage: ${SCRIPT} [options] VERSION"
    echo ""
    echo "options:"
    echo "  --real     Upload to real PyPI (else, test PyPI is used)"
}


while [[ $# -gt 0 ]]; do
    case $1 in
        --real)
            REAL=1
            shift
            ;;
        -h|--help)
            help
            exit 0
            ;;
        -*)
            echo "Unknown option: $1"
            echo ""
            help
            exit 1
            ;;
        *)
            VERSION="$1"
            shift
            break
            ;;
    esac
done


if [ -z "${REAL}" ]; then
    TWINE_ARGS+=("--repository" "testpypi")
fi

if [ -z "${VERSION}" ]; then
    echo "VERSION argument is required"
    echo ""
    help
    exit 1
fi

source "${ROOT}/bin/dist-functions"

load_dist_files"${VERSION}"

if [ "${#DIST_FILES[@]}" -eq 0 ]; then
    echo "No distributions found, aborting"
    exit 1
fi
twine check --strict "${DIST_FILES[@]}"
if [ "${#DIST_FILES[@]}" -ne 113 ]; then
    echo "Some distributions are missing, aborting"
    exit 1
fi

twine upload "${TWINE_ARGS[@]}" "${DIST_FILES[@]}"
